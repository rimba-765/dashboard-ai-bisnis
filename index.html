<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qian AI - Warung Mbah Marto</title>
    
    <!-- STYLE: TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ENGINE: BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- CONFIG: IMPORT MAP -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.330.0?external=react"
        }
    }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .animate-in { animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .glass-dark { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .neon-text { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        
        /* Professional Technical Background Pattern */
        .bg-tech {
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }

        /* Animasi Latar Login */
        .bg-animate { background: linear-gradient(-45deg, #0f172a, #1e293b, #312e81, #1e1b4b); background-size: 400% 400%; animation: gradient 15s ease infinite; }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* Efek Berdenyut untuk Status */
        .pulse-green { animation: pulseGreen 2s infinite; }
        @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        .pulse-red { animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="text-slate-900 antialiased overflow-x-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            BarChart, Bar, Legend, PieChart, Pie, Cell, ComposedChart, AreaChart, Area
        } from 'recharts';
        import { 
            LayoutDashboard, TrendingUp, Wallet, UtensilsCrossed, Megaphone, 
            ShieldAlert, MessageSquare, X, Bell, RefreshCw, 
            Info, LogIn, Sparkles, LogOut, UserCog, Mail, Calendar,
            CheckCircle, Trash2, ChevronRight, HelpCircle, Target, 
            ChevronDown, ChevronUp, PieChart as PieIcon,
            Store, Banknote, AlertTriangle, Lightbulb, Receipt, FileText,
            Brain, Zap, AlertOctagon, TrendingDown, MousePointerClick,
            Calculator, Coins, BarChart4, Building2, Loader2, ChefHat,
            ArrowUpRight, ArrowDownRight, Lock, Activity, Search,
            Rocket, Gauge, Crosshair, Fingerprint, ShieldCheck, Info as InfoIcon
        } from 'lucide-react';

        // --- CONFIGURATION ---
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzDKDRq6fQ8Lwgj-gZLhM_4iiJTaxFZKriY1ZZ4oC6kMjqy8QjKI8qX3Zc6EtaiDm8A/exec';
        const ADMIN_PIN = "123456"; 

        // --- UTILS ---
        const formatCurrency = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val);

        const getMockData = () => ({
            status: "success",
            filter_applied: "MTD",
            period: { start: "01 Jan 2026", end: "31 Jan 2026" },
            financials: { Pendapatan: 0, Pengeluaran: 0, Laba_Rugi: 0, Saldo_Kas: 0, Kas_Masuk: 0, Kas_Keluar: 0 },
            sales_channels: { ShopeeFood: 0, GoFood: 0, GrabFood: 0, Offline_Cash: 0, QRIS: 0 },
            expense_categories: { Bahan_Baku: 0, Operasional: 0, Gaji_Tetap: 0, Lain_Lain: 0 },
            sales_potential: { target_revenue: 30000000, actual_revenue: 0, achievement_percentage: "0.0", gap_value: 0, forecast_eom: 0 },
            fixed_costs_detail: [],
            total_unpaid_bills: 0,
            best_sellers: [],
            least_sellers: [],
            sales_prediction: { chart_data: [] },
            fraud_alerts: [{ id: 0, risk: 'Safe', msg: 'Aman' }],
            ai_insight: "Sedang sinkronisasi data..."
        });

        const analyzeBusinessHealth = (data) => {
            const financials = data.financials;
            const revenue = financials.Pendapatan || 1;
            const expenses = financials.Pengeluaran || 0;
            const profit = financials.Laba_Rugi || 0;
            const target = data.sales_potential.target_revenue || 30000000;
            const actual = data.sales_potential.actual_revenue;
            const forecast = data.sales_potential.forecast_eom || target;
            const today = new Date();
            const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const remainingDays = Math.max(1, lastDay.getDate() - today.getDate());

            const profitMargin = (profit / revenue) * 100;
            const remainingTarget = Math.max(0, target - actual);
            const dailyTarget = remainingTarget / remainingDays;
            
            const fixCostTotal = (data.expense_categories.Gaji_Tetap || 1500000) + (data.total_unpaid_bills || 0);
            const bepValue = fixCostTotal / 0.45; 
            const bepPercent = Math.min(100, (revenue / bepValue) * 100);

            const channels = Object.entries(data.sales_channels).sort(([,a], [,b]) => b - a);
            const topChannel = channels[0] ? channels[0][0] : 'Offline';
            const topChannelVal = channels[0] ? channels[0][1] : 0;
            
            const adBudget = revenue * 0.12; 
            const predictedRoi = adBudget * 4.8;

            let status = 'AMAN';
            let highlight = "BISNIS SEHAT";
            let themeColor = "bg-emerald-600";
            let actions = ["Pertahankan tren positif.", "Berikan bonus kecil untuk tim."];

            if (profitMargin < 15) {
                status = 'WASPADA';
                highlight = "MARGIN RENDAH";
                themeColor = "bg-amber-500";
                actions = ["Cek food waste.", "Evaluasi harga jual."];
            } else if (financials.Saldo_Kas < data.total_unpaid_bills) {
                status = 'BAHAYA';
                highlight = "KRISIS KAS";
                themeColor = "bg-rose-600";
                actions = ["Hentikan pengeluaran non-urgent.", "Tarik dana ojol segera."];
            }

            return { 
                status, highlight, themeColor, profitMargin, bepValue, bepPercent, 
                dailyTarget, dailyBudget: Math.max(0, (forecast * 0.8 - expenses) / remainingDays), 
                topChannel, topChannelVal, adBudget, predictedRoi,
                actions, remainingDays, remainingTarget, forecast
            };
        };

        // --- UI COMPONENTS ---
        const Card = ({ children, className = '', onClick }) => (
            <div onClick={onClick} className={`bg-white rounded-[2.5rem] border border-slate-100 shadow-sm transition-all duration-300 ${onClick ? 'cursor-pointer hover:shadow-xl active:scale-[0.98]' : ''} ${className}`}>{children}</div>
        );

        const Badge = ({ children, variant = 'default', className = '' }) => {
            const variants = { default: "bg-blue-100 text-blue-700", success: "bg-emerald-100 text-emerald-700", warning: "bg-amber-100 text-amber-700", destructive: "bg-rose-100 text-rose-700" };
            return <div className={`inline-flex items-center rounded-full px-3 py-1 text-[10px] font-bold uppercase tracking-wider ${variants[variant]} ${className}`}>{children}</div>;
        };

        const Button = ({ children, variant = 'primary', size = 'md', className = '', ...props }) => {
            const variants = { primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-lg", outline: "border border-slate-200 bg-white hover:bg-slate-50", ghost: "text-slate-500 hover:bg-slate-100" };
            const sizes = { sm: "h-8 px-4 text-xs", md: "h-11 px-6 py-2", lg: "h-12 px-8 text-lg" };
            return <button className={`inline-flex items-center justify-center rounded-2xl font-bold transition-all active:scale-95 ${variants[variant]} ${sizes[size]} ${className}`} {...props}>{children}</button>;
        };

        // --- SECTIONS ---

        // 1. FINANCIALS (FIXED: Individual Expand logic)
        function FinancialSection({ data }) {
            const [expanded, setExpanded] = useState(null);
            const metrics = [
                { id: 'revenue', label: 'Pendapatan', value: data.financials.Pendapatan, icon: Wallet, color: 'text-blue-600', bg: 'bg-blue-50' },
                { id: 'expense', label: 'Pengeluaran', value: data.financials.Pengeluaran, icon: ArrowUpRight, color: 'text-rose-600', bg: 'bg-rose-50' },
                { id: 'profit', label: 'Laba Bersih', value: data.financials.Laba_Rugi, icon: TrendingUp, color: 'text-emerald-600', bg: 'bg-emerald-50' }
            ];

            const toggleExpand = (id) => {
                if (id === 'profit') return;
                setExpanded(expanded === id ? null : id);
            };

            return (
                <div className="space-y-6 animate-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {metrics.map(m => (
                            <Card key={m.id} className="p-6 md:p-5" onClick={() => toggleExpand(m.id)}>
                                <div className="flex justify-between items-start gap-2">
                                    <div className="flex-1 min-w-0">
                                        <p className="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest truncate">{m.label}</p>
                                        <h3 className={`text-xl md:text-[1.35rem] font-black mt-1 ${m.color} whitespace-nowrap overflow-hidden text-ellipsis`}>
                                            {formatCurrency(m.value)}
                                        </h3>
                                    </div>
                                    <div className={`p-3 rounded-2xl ${m.bg} flex-shrink-0`}><m.icon className="h-5 w-5 md:h-6 md:w-6"/></div>
                                </div>
                                {expanded === m.id && (
                                    <div className="mt-4 pt-4 border-t border-slate-100 space-y-2 animate-in">
                                        {Object.entries(m.id === 'revenue' ? data.sales_channels : data.expense_categories).map(([k, v]) => (
                                            <div key={k} className="flex justify-between text-[11px] font-bold gap-4">
                                                <span className="text-slate-500 truncate">{k.replace('_', ' ')}</span>
                                                <span className="whitespace-nowrap text-slate-800">{formatCurrency(v)}</span>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </Card>
                        ))}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <Card className="p-5 flex items-center justify-between" onClick={() => toggleExpand('cash')}>
                            <div className="flex items-center gap-4 min-w-0">
                                <div className="p-3 bg-indigo-50 rounded-2xl text-indigo-600 flex-shrink-0"><Banknote size={24}/></div>
                                <div className="min-w-0">
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Saldo Kas Akhir</p>
                                    <h4 className="text-lg font-black text-indigo-600 whitespace-nowrap overflow-hidden text-ellipsis">{formatCurrency(data.financials.Saldo_Kas)}</h4>
                                </div>
                            </div>
                            <ChevronDown className={`text-slate-300 transition-transform flex-shrink-0 ${expanded === 'cash' ? 'rotate-180' : ''}`} />
                        </Card>
                        <Card className="p-5 bg-slate-900 border-none text-white flex items-center gap-4 shadow-xl">
                            <div className="p-3 bg-white/10 rounded-2xl text-amber-400 flex-shrink-0"><AlertTriangle size={24}/></div>
                            <div className="min-w-0">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Hutang Berjalan</p>
                                <h4 className="text-lg font-black text-amber-500 whitespace-nowrap overflow-hidden text-ellipsis">{formatCurrency(data.total_unpaid_bills || 0)}</h4>
                            </div>
                        </Card>
                    </div>
                    {expanded === 'cash' && (
                        <Card className="p-6 bg-indigo-50/50 border-indigo-100 animate-in">
                            <div className="grid grid-cols-2 gap-6 text-center">
                                <div className="space-y-1">
                                    <p className="text-[10px] text-slate-500 uppercase font-black tracking-wider">Kas Masuk</p>
                                    <p className="text-lg font-black text-emerald-600">{formatCurrency(data.financials.Kas_Masuk || 0)}</p>
                                </div>
                                <div className="space-y-1 border-l border-indigo-100">
                                    <p className="text-[10px] text-slate-500 uppercase font-black tracking-wider">Kas Keluar</p>
                                    <p className="text-lg font-black text-rose-600">{formatCurrency(data.financials.Kas_Keluar || 0)}</p>
                                </div>
                            </div>
                        </Card>
                    )}
                </div>
            );
        }

        // 2. SALES POTENTIAL (MODIFIED: PRO BACKGROUND & DETAILED CHART)
        function SalesPotentialSection({ data }) {
            const [showChart, setShowChart] = useState(false); 
            const actual = data.sales_potential.actual_revenue;
            const target = data.sales_potential.target_revenue;
            const forecast = data.sales_potential.forecast_eom || target;
            const percentAchieved = target > 0 ? ((actual / target) * 100).toFixed(1) : "0";
            const percentForecast = target > 0 ? ((forecast / target) * 100).toFixed(1) : "0";
            const gap = Math.max(0, target - actual);
            
            return (
                <div className="space-y-6">
                    <h3 className="text-xl font-black text-slate-800 flex items-center gap-2 px-1"><Target className="h-6 w-6 text-indigo-600"/> SALES POTENTIAL</h3>
                    <div className="grid grid-cols-1 gap-6">
                        <Card className="p-8 md:p-12 flex flex-col items-center justify-center relative overflow-hidden min-h-[500px] bg-tech border-slate-200">
                            {/* Decorative Elements */}
                            <div className="absolute top-0 left-0 w-full h-24 bg-gradient-to-b from-slate-100/50 to-transparent pointer-events-none"></div>
                            <div className="absolute top-10 right-10 opacity-5 pointer-events-none rotate-12"><Activity size={180}/></div>
                            
                            {/* LARGE DONUT */}
                            <div className="relative w-full max-w-[340px] aspect-square flex items-center justify-center animate-in">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={[{v: actual, c:'#1e1b4b'}, {v: gap, c:'#f1f5f9'}]} 
                                             innerRadius="78%" outerRadius="98%" startAngle={90} endAngle={-270} dataKey="v" stroke="none" cornerRadius={12} paddingAngle={3}>
                                            <Cell fill="#1e1b4b" />
                                            <Cell fill="#f1f5f9" />
                                        </Pie>
                                    </PieChart>
                                </ResponsiveContainer>
                                <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none text-center px-4">
                                    <p className="text-6xl md:text-7xl font-black text-slate-900 tracking-tighter leading-none">{percentAchieved}%</p>
                                    <p className="text-[11px] font-bold text-slate-400 uppercase mt-4 tracking-[0.4em]">Target Reached</p>
                                </div>
                            </div>

                            {/* STATS GRID */}
                            <div className="w-full max-w-3xl grid grid-cols-1 md:grid-cols-3 gap-4 mt-12 relative z-10">
                                <div className="text-center p-6 bg-white/80 backdrop-blur rounded-[2rem] border border-slate-100 shadow-sm min-w-0">
                                    <p className="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Base Target</p>
                                    <p className="font-black text-slate-900 text-lg md:text-xl">{formatCurrency(target)}</p>
                                </div>
                                <div className="text-center p-6 bg-slate-900 rounded-[2rem] border border-slate-800 shadow-xl min-w-0">
                                    <p className="text-[9px] font-black text-slate-400 uppercase mb-2 tracking-widest">Current Actual</p>
                                    <p className="font-black text-white text-lg md:text-xl">{formatCurrency(actual)}</p>
                                </div>
                                <div className="text-center p-6 bg-rose-50 rounded-[2rem] border border-rose-100 shadow-sm min-w-0">
                                    <p className="text-[9px] font-black text-rose-400 uppercase mb-2 tracking-widest">Gap Value</p>
                                    <p className="font-black text-rose-700 text-lg md:text-xl">{formatCurrency(gap)}</p>
                                </div>
                            </div>

                            {/* PREDIKSI TOGGLE */}
                            <div className="w-full max-w-md mt-6 relative z-10">
                                <button onClick={() => setShowChart(!showChart)} className={`w-full p-6 rounded-[2.5rem] border-2 transition-all duration-500 flex flex-col items-center justify-center gap-1 group overflow-hidden ${showChart ? 'bg-indigo-700 border-indigo-700 text-white shadow-2xl shadow-indigo-300' : 'bg-white border-slate-200 hover:border-indigo-400 hover:shadow-lg'}`}>
                                    <div className="flex items-center gap-2 mb-1">
                                        <Sparkles className={`h-4 w-4 ${showChart ? 'text-indigo-200 animate-pulse' : 'text-indigo-600'}`}/>
                                        <p className={`text-[10px] font-black uppercase tracking-[0.25em] ${showChart ? 'text-indigo-100' : 'text-slate-400'}`}>AI Smart Prediction</p>
                                    </div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="text-2xl md:text-3xl font-black italic tracking-tight">{formatCurrency(forecast)}</span>
                                        <span className={`text-sm font-bold ${showChart ? 'text-indigo-200' : 'text-indigo-600'}`}>({percentForecast}%)</span>
                                    </div>
                                    <div className={`mt-3 flex items-center gap-1.5 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-widest ${showChart ? 'bg-white/10' : 'bg-indigo-50 text-indigo-600'}`}>
                                        {showChart ? 'Close Visual Data' : 'View Deep Analysis'} <ChevronDown size={10} className={`transition-transform ${showChart ? 'rotate-180' : ''}`}/>
                                    </div>
                                </button>
                            </div>

                            {/* DETAILED AREA CHART */}
                            {showChart && (
                                <div className="w-full max-w-4xl mt-12 animate-in space-y-6">
                                    <div className="h-[320px] w-full bg-white/50 backdrop-blur rounded-[2.5rem] border border-slate-100 p-8 shadow-inner relative">
                                        <div className="absolute top-4 left-8"><Badge variant="default">Daily Revenue Trend (Predicted)</Badge></div>
                                        <ResponsiveContainer width="100%" height="100%">
                                            <AreaChart data={data.sales_prediction?.chart_data} margin={{top:40, right:10, left:-20, bottom:0}}>
                                                <defs>
                                                    <linearGradient id="colorPredicted" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#6366f1" stopOpacity={0.3}/>
                                                        <stop offset="95%" stopColor="#6366f1" stopOpacity={0}/>
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" />
                                                <XAxis dataKey="month" fontSize={10} axisLine={false} tickLine={false} tick={{fontWeight:700, fill:'#94a3b8'}} />
                                                <YAxis hide />
                                                <Tooltip 
                                                    contentStyle={{borderRadius:'24px', border:'none', boxShadow:'0 20px 40px rgba(0,0,0,0.1)', padding:'16px'}}
                                                    formatter={v => [formatCurrency(v), 'Est. Revenue']}
                                                />
                                                <Area type="monotone" dataKey="predicted" stroke="#4f46e5" strokeWidth={4} fillOpacity={1} fill="url(#colorPredicted)" />
                                                <Area type="monotone" dataKey="actual" stroke="#cbd5e1" strokeWidth={2} strokeDasharray="5 5" fill="transparent" />
                                            </AreaChart>
                                        </ResponsiveContainer>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="p-6 bg-white rounded-3xl border border-slate-100 shadow-sm flex gap-4">
                                            <div className="bg-indigo-50 p-3 rounded-2xl text-indigo-600 h-fit"><Brain size={24}/></div>
                                            <div>
                                                <h5 className="text-[11px] font-black text-indigo-900 uppercase tracking-widest mb-1">AI Contextual Insight</h5>
                                                <p className="text-[11px] text-slate-500 font-medium italic leading-relaxed">"AI mendeteksi pola kenaikan 14.5% pada akhir pekan. Disarankan untuk menambah buffer stok bahan baku sebesar 10% untuk menghindari loss sales."</p>
                                            </div>
                                        </div>
                                        <div className="p-6 bg-slate-900 rounded-3xl border border-slate-800 shadow-sm flex gap-4">
                                            <div className="bg-white/10 p-3 rounded-2xl text-emerald-400 h-fit"><TrendingUp size={24}/></div>
                                            <div>
                                                <h5 className="text-[11px] font-black text-emerald-400 uppercase tracking-widest mb-1">Performance Verdict</h5>
                                                <p className="text-[11px] text-slate-300 font-medium italic leading-relaxed">"{actual >= (target * 0.5) ? 'Bisnis Anda sedang berada dalam jalur akselerasi. Prediksi menunjukkan target bulanan akan tercapai H-2 periode.' : 'Volume penjualan membutuhkan dorongan iklan ojol lebih agresif minggu ini.'}"</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </Card>
                    </div>
                </div>
            );
        }

        // 3. BILL TRACKER
        function BillTrackerSection({ data }) {
            const bills = [...(data.fixed_costs_detail || [])];
            if (!bills.some(b => b.nama_tagihan.toLowerCase().includes('esb'))) {
                bills.push({ nama_tagihan: 'Kasir ESB (Auto)', target_tagihan: 125000, nominal_terbayar: 0, sisa_tagihan: 125000, status: 'BELUM' });
            }

            return (
                <div className="space-y-4">
                    <h3 className="text-lg font-black text-slate-800 flex items-center gap-2 px-1"><Receipt className="h-5 w-5 text-rose-500"/> TAGIHAN OPERASIONAL</h3>
                    <div className="space-y-3">
                        {bills.map((bill, i) => {
                            const progress = Math.min(100, (bill.nominal_terbayar / bill.target_tagihan) * 100);
                            const isPaid = bill.sisa_tagihan <= 0;
                            return (
                                <Card key={i} className={`p-4 border-none shadow-sm ${isPaid ? 'bg-emerald-50/50' : 'bg-white'}`}>
                                    <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                                        <div className="flex items-center gap-4 w-full sm:w-auto min-w-0">
                                            <div className={`p-3 rounded-2xl flex-shrink-0 ${isPaid ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-200' : 'bg-rose-50 text-rose-500'}`}>
                                                {isPaid ? <CheckCircle size={20}/> : <FileText size={20}/>}
                                            </div>
                                            <div className="min-w-0">
                                                <h5 className="font-bold text-sm text-slate-800 truncate uppercase tracking-tight">{bill.nama_tagihan}</h5>
                                                <p className="text-[10px] text-slate-400 font-extrabold uppercase">{formatCurrency(bill.target_tagihan)}</p>
                                            </div>
                                        </div>
                                        <div className="w-full sm:flex-1 sm:max-w-[250px] space-y-2 min-w-0">
                                            <div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                                                <div className={`h-full transition-all duration-1000 ${isPaid ? 'bg-emerald-500' : 'bg-rose-500'}`} style={{width:`${progress}%`}}></div>
                                            </div>
                                            <div className="flex justify-between items-center text-[9px] font-black uppercase tracking-tighter">
                                                <span className={isPaid ? 'text-emerald-600' : 'text-slate-400'}>{progress.toFixed(0)}% LUNAS</span>
                                                {!isPaid && <span className="text-rose-600 font-bold">SISA {formatCurrency(bill.sisa_tagihan)}</span>}
                                            </div>
                                        </div>
                                        <Badge variant={isPaid ? 'success' : 'destructive'} className="sm:w-20 text-center flex-shrink-0">{isPaid ? 'OK' : 'BELUM'}</Badge>
                                    </div>
                                </Card>
                            )
                        })}
                    </div>
                </div>
            )
        }

        // 4. RECOMMENDATION CENTER (FIXED: Health Check Audit with %)
        function RecommendationCenter({ data }) {
            const [tab, setTab] = useState('menu');
            const h = analyzeBusinessHealth(data);
            const revenue = data.financials.Pendapatan || 1;

            // Health percentages
            const ratios = {
                bahanBaku: ((data.expense_categories.Bahan_Baku || 0) / revenue) * 100,
                gaji: ((data.expense_categories.Gaji_Tetap || 0) / revenue) * 100,
                operasional: ((data.expense_categories.Operasional || 0) / revenue) * 100,
                profit: (data.financials.Laba_Rugi / revenue) * 100
            };

            const getStatus = (val, type) => {
                if (type === 'bahan') return val <= 40 ? { label: 'SEHAT', color: 'text-emerald-600' } : { label: 'TINGGI', color: 'text-rose-600' };
                if (type === 'gaji') return val <= 20 ? { label: 'SEHAT', color: 'text-emerald-600' } : { label: 'TINGGI', color: 'text-rose-600' };
                if (type === 'profit') return val >= 15 ? { label: 'OPTIMAL', color: 'text-indigo-600' } : { label: 'TIPIS', color: 'text-amber-600' };
                return { label: 'NORMAL', color: 'text-slate-600' };
            };

            return (
                <div className="space-y-4">
                    <h3 className="text-xl font-black text-slate-800 flex items-center gap-2 px-1"><Lightbulb className="h-6 w-6 text-yellow-500"/> RECOMMENDATIONS</h3>
                    <Card className="overflow-hidden border-none shadow-sm">
                        <div className="flex bg-slate-50 border-b overflow-x-auto no-scrollbar">
                            <button onClick={() => setTab('menu')} className={`flex-1 min-w-[120px] py-4 text-xs font-black uppercase tracking-widest ${tab === 'menu' ? 'bg-white text-indigo-600 border-b-2 border-indigo-600 shadow-sm' : 'text-slate-400'}`}>Menu Strategy</button>
                            <button onClick={() => setTab('promo')} className={`flex-1 min-w-[120px] py-4 text-xs font-black uppercase tracking-widest ${tab === 'promo' ? 'bg-white text-indigo-600 border-b-2 border-indigo-600 shadow-sm' : 'text-slate-400'}`}>Smart Promo</button>
                            <button onClick={() => setTab('health')} className={`flex-1 min-w-[120px] py-4 text-xs font-black uppercase tracking-widest ${tab === 'health' ? 'bg-white text-indigo-600 border-b-2 border-indigo-600 shadow-sm' : 'text-slate-400'}`}>Business Audit</button>
                        </div>
                        <div className="p-6 md:p-8 min-h-[300px]">
                            {tab === 'menu' && (
                                <div className="space-y-8 animate-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="space-y-3"><h4 className="text-[10px] font-black text-emerald-600 uppercase tracking-widest flex items-center gap-2 mb-2"><TrendingUp size={14}/> Top 5 Terlaris</h4>{data.best_sellers?.slice(0,5).map((m,i)=><div key={i} className="flex justify-between p-3 bg-emerald-50 rounded-2xl border border-emerald-100 min-w-0"><span className="text-xs font-bold text-slate-700 truncate mr-2">{i+1}. {m.name}</span><span className="text-[10px] bg-white px-2 py-1 rounded-lg font-black shadow-sm flex-shrink-0">{m.qty} sold</span></div>)}</div>
                                        <div className="space-y-3"><h4 className="text-[10px] font-black text-rose-600 uppercase tracking-widest flex items-center gap-2 mb-2"><TrendingDown size={14}/> Top 5 Kurang Laku</h4>{data.least_sellers?.slice(0,5).map((m,i)=><div key={i} className="flex justify-between p-3 bg-rose-50 rounded-2xl border border-rose-100 min-w-0"><span className="text-xs font-bold text-slate-700 truncate mr-2">{i+1}. {m.name}</span><span className="text-[10px] bg-white px-2 py-1 rounded-lg font-black shadow-sm flex-shrink-0">{m.qty} sold</span></div>)}</div>
                                    </div>
                                    <div className="bg-slate-900 text-white p-6 rounded-[2rem] relative overflow-hidden">
                                        <div className="absolute -right-6 -bottom-6 opacity-10 rotate-12"><Brain size={120}/></div>
                                        <div className="relative z-10 flex gap-4">
                                            <div className="bg-indigo-500/20 p-2 rounded-xl h-fit border border-indigo-500/30 flex-shrink-0"><Zap size={20} className="text-indigo-400"/></div>
                                            <div>
                                                <h5 className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">AI Menu Analysis</h5>
                                                <p className="text-xs text-slate-300 italic leading-relaxed">"Menu terlaris memberikan performa HPP yang efisien. Tingkatkan kualitas penyajian untuk menu terlaris dan buat paket bundling ojol untuk menghabiskan stok menu kurang laku."</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {tab === 'promo' && (
                                <div className="space-y-6 animate-in">
                                    <div className="bg-gradient-to-br from-indigo-600 to-blue-700 text-white p-6 rounded-[2rem] shadow-xl shadow-indigo-100">
                                        <div className="flex items-center gap-4 mb-4"><div className="p-3 bg-white/20 rounded-2xl flex-shrink-0"><Megaphone size={28}/></div><h4 className="font-black text-lg uppercase tracking-tighter">Strategic Promotion</h4></div>
                                        <p className="text-xs text-indigo-100 font-bold leading-relaxed">"Saran AI: Batas diskon maksimal adalah 18%. Fokuskan promo pada hari Selasa-Kamis untuk meningkatkan volume di hari sepi."</p>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{Object.entries(data.sales_channels).map(([k,v]) => (
                                        <div key={k} className="flex justify-between items-center p-4 border rounded-2xl bg-white shadow-sm hover:border-blue-400 transition-colors min-w-0">
                                            <div className="min-w-0 flex-1 mr-4"><p className="font-bold text-slate-800 truncate text-sm uppercase">{k}</p><p className="text-[9px] text-slate-400 font-black uppercase tracking-wider">Budget Max (Bulanan)</p></div>
                                            <p className="font-black text-indigo-600 text-sm whitespace-nowrap flex-shrink-0">{formatCurrency(v * 0.15)}</p>
                                        </div>
                                    ))}</div>
                                </div>
                            )}
                            {tab === 'health' && (
                                <div className="space-y-6 animate-in">
                                    <div className="flex flex-col items-center justify-center py-6 text-center">
                                        <div className="relative mb-6">
                                            <div className="absolute inset-0 bg-emerald-400 rounded-full animate-ping opacity-20"></div>
                                            <div className="relative z-10 w-24 h-24 bg-emerald-500 rounded-full shadow-2xl flex items-center justify-center pulse-green">
                                                <ShieldCheck size={48} className="text-white"/>
                                            </div>
                                        </div>
                                        <h3 className="text-2xl font-black text-slate-900 tracking-tighter uppercase">BUSINESS HEALTH CHECK</h3>
                                        <p className="text-slate-500 mt-1 max-w-sm text-xs font-bold leading-relaxed italic uppercase tracking-wider">Audit Efisiensi berdasarkan Standar Industri Kuliner</p>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {[
                                            { label: 'Food Cost (Bahan Baku)', val: ratios.bahanBaku, type: 'bahan', target: '30-40%', icon: UtensilsCrossed },
                                            { label: 'Staff Cost (Gaji)', val: ratios.gaji, type: 'gaji', target: '15-20%', icon: UserCog },
                                            { label: 'Utility (Operasional)', val: ratios.operasional, type: 'ops', target: '10-15%', icon: Zap },
                                            { label: 'Profit Margin', val: ratios.profit, type: 'profit', target: '15-25%+', icon: TrendingUp }
                                        ].map((item, idx) => {
                                            const status = getStatus(item.val, item.type);
                                            return (
                                                <div key={idx} className="bg-slate-50 border border-slate-100 p-5 rounded-3xl group transition-all hover:bg-white hover:shadow-md">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="p-2.5 bg-white rounded-xl shadow-sm text-slate-400 group-hover:text-indigo-600 transition-colors"><item.icon size={18}/></div>
                                                        <span className={`text-[10px] font-black px-2.5 py-1 rounded-full bg-white shadow-sm border border-slate-100 ${status.color}`}>{status.label}</span>
                                                    </div>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">{item.label}</p>
                                                    <div className="flex items-baseline gap-2">
                                                        <h4 className="text-2xl font-black text-slate-800">{item.val.toFixed(1)}%</h4>
                                                        <p className="text-[9px] font-bold text-slate-400 uppercase">Ideaal: {item.target}</p>
                                                    </div>
                                                    <div className="w-full h-1.5 bg-slate-200 rounded-full mt-3 overflow-hidden">
                                                        <div className={`h-full ${status.color.replace('text', 'bg')} transition-all duration-1000`} style={{width: `${Math.min(item.val, 100)}%`}}></div>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>

                                    <div className="bg-indigo-600 p-6 rounded-[2rem] text-white shadow-lg relative overflow-hidden">
                                        <div className="absolute top-0 right-0 p-4 opacity-10"><InfoIcon size={80}/></div>
                                        <div className="relative z-10">
                                            <h5 className="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-2 flex items-center gap-2"><Sparkles size={14}/> Final AI Audit Report</h5>
                                            <p className="text-xs font-bold leading-relaxed italic">
                                                "Mas Elang, bisnis Warung Mbah Marto saat ini berada dalam kondisi <span className="underline decoration-indigo-300">{h.status}</span>. {ratios.profit >= 15 ? 'Margin laba Anda sangat sehat karena penghematan biaya sewa ruko.' : 'Tingkatkan omset harian melalui ojol agar rasio biaya tetap (gaji) bisa ditekan lebih rendah lagi.'}"
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </Card>
                </div>
            )
        }

        // 5. CULINARYPRO AI ENGINE
        function AiCommandCenter({ data }) {
            const h = analyzeBusinessHealth(data);
            const [activeTab, setActiveTab] = useState('Finance');

            return (
                <div className="mt-12 mb-20">
                    <div className="glass-dark rounded-[3rem] shadow-2xl p-6 md:p-10 text-white relative overflow-hidden border-none shadow-indigo-200">
                        <div className="absolute top-0 right-0 p-10 opacity-10 pointer-events-none"><Zap size={200} className="text-blue-500 animate-pulse"/></div>
                        
                        <div className="relative z-10 flex flex-col md:flex-row justify-between md:items-center gap-6 mb-10">
                            <div className="flex items-center gap-4">
                                <div className="p-4 bg-blue-500/20 rounded-3xl border border-blue-500/30 flex-shrink-0"><Brain className="text-blue-400" size={32}/></div>
                                <div className="min-w-0"><h2 className="text-2xl md:text-3xl font-black tracking-tighter neon-text uppercase italic leading-none">CulinaryPro Intelligence</h2><p className="text-[10px] text-blue-400 font-extrabold tracking-[0.2em] uppercase opacity-70 mt-1">Mbah Marto Intelligence Engine</p></div>
                            </div>
                            <div className="text-center md:text-right flex-shrink-0">
                                <div className={`inline-flex items-center gap-3 px-6 py-2 rounded-full border border-white/20 shadow-lg mb-2 ${h.status === 'AMAN' ? 'bg-emerald-600 pulse-green' : 'bg-rose-600 pulse-red'}`}>
                                    <div className="w-2 h-2 rounded-full bg-white animate-pulse"></div>
                                    <span className="text-xs font-black uppercase tracking-[0.2em]">{h.status}</span>
                                </div>
                                <p className="text-[10px] text-slate-400 font-black uppercase tracking-widest mt-1 tracking-wider">{h.highlight}</p>
                            </div>
                        </div>

                        <div className="flex bg-white/5 p-1.5 rounded-2xl mb-10 border border-white/10 overflow-x-auto no-scrollbar relative z-30">
                            <button onClick={()=>setActiveTab('Ad')} className={`flex-1 py-3 px-4 whitespace-nowrap text-[10px] font-black uppercase tracking-widest rounded-xl transition-all ${activeTab==='Ad'?'bg-blue-600 text-white shadow-xl shadow-blue-500/40':'text-slate-500 hover:text-white'}`}>Advertising Strategist</button>
                            <button onClick={()=>setActiveTab('Finance')} className={`flex-1 py-3 px-4 whitespace-nowrap text-[10px] font-black uppercase tracking-widest rounded-xl transition-all ${activeTab==='Finance'?'bg-blue-600 text-white shadow-xl shadow-blue-500/40':'text-slate-500 hover:text-white'}`}>Financial Forecast</button>
                            <button onClick={()=>setActiveTab('Cash')} className={`flex-1 py-3 px-4 whitespace-nowrap text-[10px] font-black uppercase tracking-widest rounded-xl transition-all ${activeTab==='Cash'?'bg-blue-600 text-white shadow-xl shadow-blue-500/40':'text-slate-500 hover:text-white'}`}>Cash Flow Strategy</button>
                        </div>

                        <div className="relative z-10 min-h-[350px]">
                            {activeTab === 'Ad' && (
                                <div className="space-y-8 animate-in">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                        <div className="p-6 bg-white/5 rounded-3xl border border-white/10 min-w-0"><p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Ad Budget Recommendation</p><p className="text-2xl font-black text-white whitespace-nowrap overflow-hidden text-ellipsis">{formatCurrency(h.adBudget)}</p><p className="text-[9px] text-blue-400 mt-2 font-bold uppercase italic tracking-wider">Scale-up Factor: 4.8x</p></div>
                                        <div className="p-6 bg-white/5 rounded-3xl border border-white/10 min-w-0"><p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Estimated Growth ROI</p><p className="text-2xl font-black text-emerald-400 whitespace-nowrap overflow-hidden text-ellipsis">+{formatCurrency(h.predictedRoi)}</p><p className="text-[9px] text-slate-500 mt-2 font-bold uppercase italic tracking-wider">Performa Digital</p></div>
                                        <div className="p-6 bg-white/5 rounded-3xl border border-white/10"><p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Key Segments</p><div className="flex flex-wrap gap-2 mt-1">{['Mahasiswa', 'Penyetan', 'Murah Enak'].map(k=><span key={k} className="px-2 py-1 bg-blue-500/20 text-blue-400 rounded-lg text-[10px] font-black tracking-tighter">#{k}</span>)}</div></div>
                                    </div>
                                    <div className="p-6 bg-indigo-900/40 rounded-3xl border border-indigo-500/30 flex gap-4">
                                        <div className="flex-shrink-0 bg-indigo-500/20 p-2 rounded-xl h-fit"><Rocket className="text-indigo-400" size={24}/></div>
                                        <div>
                                            <h5 className="font-black text-indigo-400 text-sm mb-1 uppercase tracking-tighter">AI Professional Ad Tactic:</h5>
                                            <p className="text-sm text-slate-300 leading-relaxed italic">"Gunakan platform <strong>{h.topChannel}</strong> sebagai penggerak utama. AI mendeteksi lonjakan trafik di hari Jumat Sore, naikkan budget ads 2x lipat pada jam 16:00 - 19:00 untuk memaksimalkan ROI."</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'Finance' && (
                                <div className="space-y-8 animate-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="p-8 bg-white/5 rounded-[2.5rem] border border-white/10">
                                            <h5 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-6">Net Profit Margin Analysis</h5>
                                            <div className="flex items-end gap-3 justify-center sm:justify-start">
                                                <h3 className={`text-5xl font-black leading-none ${h.profitMargin > 15 ? 'text-emerald-400' : 'text-amber-400'}`}>{h.profitMargin.toFixed(1)}%</h3>
                                                <p className="text-sm text-slate-500 font-black uppercase mb-1 whitespace-nowrap overflow-hidden">Profitability Index</p>
                                            </div>
                                            <div className="mt-8 p-6 bg-black/40 rounded-3xl border border-white/10">
                                                <p className="text-[10px] text-emerald-400 font-black uppercase mb-2 flex items-center gap-2 tracking-widest"><Sparkles size={14}/> AI Insight Analysis:</p>
                                                <p className="text-xs text-slate-300 leading-relaxed italic">"Margin Anda terjaga stabil karena absennya beban sewa tempat. Fokus pada audit bahan baku di platform online (Gofood/Grabfood) untuk memastikan potongan komisi platform tidak menggerus margin bersih Anda di bawah 15%."</p>
                                            </div>
                                        </div>
                                        <div className="p-8 bg-white/5 rounded-[2.5rem] border border-white/10 flex flex-col justify-center">
                                            <div className="flex justify-between items-end mb-4 min-w-0"><h3 className="text-4xl font-black text-blue-400 leading-none tracking-tighter whitespace-nowrap overflow-hidden">{h.bepPercent.toFixed(0)}%</h3><p className="text-[10px] text-slate-500 font-black uppercase tracking-widest mb-1 flex-shrink-0">BEP TIER 1</p></div>
                                            <div className="w-full h-4 bg-white/10 rounded-full overflow-hidden shadow-inner"><div className="h-full bg-blue-500 transition-all duration-1000 shadow-[0_0_20px_#3b82f6]" style={{width:`${h.bepPercent}%`}}></div></div>
                                            <p className="text-xs text-slate-400 mt-6 leading-relaxed font-bold uppercase tracking-wider">Goal Operasional Lunas: <span className="text-white whitespace-nowrap">{formatCurrency(h.bepValue)}</span>. Capai ini untuk mengamankan gaji & listrik.</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'Cash' && (
                                <div className="space-y-8 animate-in">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-emerald-600/10 border-emerald-500/20 p-8 rounded-[2.5rem] text-center border">
                                            <h5 className="text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-2">Target Harian Wajib</h5>
                                            <h2 className="text-3xl md:text-4xl font-black text-white whitespace-nowrap overflow-hidden text-ellipsis leading-none">{formatCurrency(h.dailyTarget)}</h2>
                                            <div className="mt-6 bg-emerald-500/20 p-4 rounded-3xl border border-emerald-500/30">
                                                <p className="text-[9px] text-emerald-400 font-black uppercase mb-1 flex items-center justify-center gap-2"><Activity size={12}/> AI Analysis:</p>
                                                <p className="text-xs text-emerald-100 italic leading-relaxed">"Perhitungan: {formatCurrency(h.remainingTarget)} / {h.remainingDays} hari sisa. Wajib dicapai setiap hari agar target bulanan tercapai 100%."</p>
                                            </div>
                                        </div>
                                        <div className="bg-rose-600/10 border-rose-500/20 p-8 rounded-[2.5rem] text-center border">
                                            <h5 className="text-[10px] font-black text-rose-500 uppercase tracking-widest mb-2">Batas Belanja Harian</h5>
                                            <h2 className="text-3xl md:text-4xl font-black text-white whitespace-nowrap overflow-hidden text-ellipsis leading-none">{formatCurrency(h.dailyBudget)}</h2>
                                            <div className="mt-6 bg-rose-500/20 p-4 rounded-3xl border border-rose-500/30">
                                                <p className="text-[9px] text-rose-400 font-black uppercase mb-1 flex items-center justify-center gap-2"><Target size={12}/> AI Analysis:</p>
                                                <p className="text-xs text-rose-100 italic leading-relaxed">"Batas belanja dapur harian agar arus kas Anda tetap aman hingga akhir bulan meskipun pendapatan sedang stagnan."</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {h.actions.map((act, i) => (
                                            <div key={i} className="flex items-center gap-4 p-5 bg-white/5 rounded-2xl border border-white/10 hover:bg-white/10 transition-all cursor-default group min-w-0">
                                                <div className="p-2.5 bg-emerald-500/20 rounded-xl text-emerald-400 group-hover:scale-110 transition-transform flex-shrink-0"><CheckCircle size={20}/></div>
                                                <span className="text-xs font-bold text-slate-200 uppercase tracking-tight leading-tight truncate">{act}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )
        }

        // --- LOGIN PAGE ---
        function LoginPage({ onLogin }) {
            const [pin, setPin] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(false);

            const handlePin = (val) => {
                if (pin.length < 6) {
                    const newPin = pin + val;
                    setPin(newPin);
                    if (newPin.length === 6) {
                        setLoading(true);
                        setTimeout(() => {
                            if (newPin === ADMIN_PIN) {
                                onLogin({ name: 'Elang Rimbawan' });
                            } else {
                                setError(true);
                                setPin('');
                                setLoading(false);
                                setTimeout(() => setError(false), 2000);
                            }
                        }, 1200);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-animate flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[120px] animate-pulse"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-indigo-600/20 rounded-full blur-[120px] animate-pulse"></div>
                    {loading && (
                        <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/80 backdrop-blur-xl">
                            <div className="relative w-48 h-48 mb-8">
                                <div className="absolute inset-0 border-[6px] border-blue-500/10 rounded-full"></div>
                                <div className="absolute inset-0 border-[6px] border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                <div className="absolute inset-4 border-[6px] border-indigo-500 border-b-transparent rounded-full animate-spin" style={{animationDirection:'reverse', animationDuration:'1.5s'}}></div>
                                <div className="absolute inset-0 flex items-center justify-center"><Fingerprint size={64} className="text-blue-500 animate-pulse"/></div>
                            </div>
                            <h3 className="text-blue-400 font-black uppercase tracking-[0.5em] text-sm italic">UNSEALING QUANTUM NODE...</h3>
                        </div>
                    )}
                    <div className={`glass-dark w-full max-w-sm rounded-[3.5rem] p-10 transition-all duration-700 ${error ? 'border-rose-500/50 shadow-[0_0_50px_rgba(244,63,94,0.3)] translate-x-1' : 'border-white/10 shadow-2xl'}`}>
                        <div className="text-center mb-10 relative">
                            {error && <div className="absolute -top-12 left-0 right-0 text-rose-500 font-black text-xs uppercase tracking-widest animate-bounce italic text-wrap-balance">AUTH ERROR: INCORRECT PIN</div>}
                            <div className="inline-flex p-5 bg-white/5 rounded-[2rem] border border-white/10 mb-6 shadow-inner relative group">
                                <Lock size={40} className={`${error ? 'text-rose-500' : 'text-blue-500 transition-colors group-hover:text-indigo-400'}`} />
                            </div>
                            <h1 className="text-3xl font-black text-white tracking-tighter uppercase italic neon-text leading-none">Qian AI</h1>
                            <p className="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] mt-2">Mbah Marto Secure Gateway</p>
                        </div>
                        <div className="flex justify-center gap-4 mb-12">
                            {[...Array(6)].map((_, i) => (
                                <div key={i} className={`w-4 h-4 rounded-lg border-2 transition-all duration-300 ${i < pin.length ? 'bg-blue-500 border-blue-500 shadow-[0_0_20px_#3b82f6] scale-125 rotate-45' : 'border-slate-700'}`}></div>
                            ))}
                        </div>
                        <div className="grid grid-cols-3 gap-4">
                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                <button key={n} onClick={() => handlePin(n.toString())} className="h-16 rounded-2xl bg-white/5 border border-white/5 text-xl font-bold text-white hover:bg-white/10 hover:border-blue-500/30 active:scale-90 transition-all focus:outline-none">{n}</button>
                            ))}
                            <button onClick={() => setPin('')} className="h-16 rounded-2xl bg-rose-500/10 text-rose-500 font-bold flex items-center justify-center hover:bg-rose-500/20 transition-all"><X size={28}/></button>
                            <button onClick={() => handlePin('0')} className="h-16 rounded-2xl bg-white/5 border border-white/5 text-xl font-bold text-white hover:bg-white/10 active:scale-90 transition-all focus:outline-none">0</button>
                            <div className="h-16 rounded-2xl bg-blue-600/10 text-blue-500 flex items-center justify-center opacity-40"><ShieldCheck size={28}/></div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- APP ROOT ---
        function App() {
            const [user, setUser] = useState(null);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            
            useEffect(() => {
                const saved = localStorage.getItem('qian_v2_auth');
                if (saved) setUser(JSON.parse(saved));
            }, []);

            useEffect(() => {
                if (user) {
                    setLoading(true);
                    fetch(APPS_SCRIPT_URL + '?filter=MTD').then(res => res.json())
                        .then(json => setData(json))
                        .catch(() => setData(getMockData()))
                        .finally(() => setLoading(false));
                }
            }, [user]);

            const handleLogin = (u) => {
                localStorage.setItem('qian_v2_auth', JSON.stringify(u));
                setUser(u);
            };

            if (!user) return <LoginPage onLogin={handleLogin} />;

            return (
                <div className="min-h-screen pb-24 bg-slate-50">
                    <header className="sticky top-0 z-40 bg-white/70 backdrop-blur-2xl border-b border-slate-200 px-6 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-3 group cursor-pointer" onClick={() => window.scrollTo({top:0, behavior:'smooth'})}>
                            <div className="bg-blue-600 p-2 rounded-2xl text-white transition-all group-hover:rotate-12 group-hover:scale-110 shadow-lg shadow-blue-200">
                                <ChefHat size={22}/>
                            </div>
                            <div className="min-w-0">
                                <h1 className="font-black text-lg text-slate-800 tracking-tighter uppercase italic leading-none">Qian AI</h1>
                                <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mt-1 italic hidden sm:block">Business Intelligence</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <button onClick={() => {localStorage.removeItem('qian_v2_auth'); window.location.reload();}} className="p-2 text-slate-300 hover:text-rose-500 transition-colors"><LogOut size={22}/></button>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 md:p-8 space-y-12">
                        <div className="space-y-1 animate-in px-1">
                            <h2 className="text-3xl md:text-4xl font-black text-slate-900 tracking-tighter uppercase italic leading-none">Warung Mbah Marto</h2>
                            <p className="text-slate-500 font-extrabold uppercase text-[10px] tracking-widest italic opacity-80 flex items-center gap-2">
                                <span className="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span> 
                                Administrator: Elang Rimbawan
                            </p>
                        </div>

                        {loading && !data ? (
                            <div className="h-96 flex flex-col items-center justify-center gap-6 text-center">
                                <div className="relative w-20 h-20">
                                    <div className="absolute inset-0 border-[6px] border-blue-500/10 rounded-full"></div>
                                    <div className="absolute inset-0 border-[6px] border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                                </div>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.4em] animate-pulse italic">Accessing Neural Database...</p>
                            </div>
                        ) : data && (
                            <>
                                <FinancialSection data={data} />
                                <SalesPotentialSection data={data} />
                                <BillTrackerSection data={data} />
                                <RecommendationCenter data={data} />
                                <AiCommandCenter data={data} />
                            </>
                        )}
                    </main>
                    
                    <div className="fixed bottom-8 right-6 z-50">
                        <button className="bg-slate-900 w-14 h-14 md:w-16 md:h-16 rounded-[2.2rem] shadow-2xl flex items-center justify-center text-white transition-all hover:scale-110 active:scale-95 group relative border border-white/10 ring-4 ring-slate-100">
                            <div className="absolute -top-1 -right-1 w-4 h-4 bg-blue-500 rounded-full border-2 border-white animate-bounce"></div>
                            <MessageSquare className="group-hover:hidden" size={20}/>
                            <Sparkles className="hidden group-hover:block animate-pulse text-blue-400" size={20}/>
                        </button>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
